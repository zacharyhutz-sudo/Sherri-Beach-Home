---
import Layout from '../layouts/Layout.astro';
import Calendar from '../components/Calendar.astro';

const API_URL = "https://api.npoint.io/9bf5ddca826de74d7320";
---

<Layout title="Booking - There’s Always Time for the Sea">
	<main class="max-w-4xl mx-auto px-6 py-12">
		<header class="mb-12 text-center">
			<h1 class="text-4xl md:text-5xl font-header text-[#92ABBB] mb-4">Book Your Stay</h1>
			<p class="text-lg opacity-80">Check availability and secure your dates.</p>
		</header>

		<div class="grid lg:grid-cols-2 gap-16">
			<!-- Calendar Section -->
			<section>
				<h2 class="text-2xl font-subheader text-[#92ABBB] mb-8">Availability</h2>
				<Calendar />
			</section>

			<!-- Booking Form Section -->
			<section>
				<h2 class="text-2xl font-subheader text-[#92ABBB] mb-8">Request Booking</h2>
				
				<form 
					id="booking-form"
					action="https://submit-form.com/63Y4pVGg9ydaxeZuMppwRH0k" 
					method="POST"
					class="space-y-6 text-left"
				>
					<!-- Target Email Override (for development) -->
					<input type="hidden" name="_to" value="zacharyhutz@gmail.com">
					<input type="hidden" name="_subject" value="New Booking Request: There’s Always Time for the Sea">

					<div class="grid md:grid-cols-2 gap-6">
						<div class="space-y-2">
							<label for="name" class="block text-sm font-bold uppercase tracking-wider text-[#9F6C52]">Name</label>
							<input type="text" id="name" name="name" required class="w-full bg-white/50 border border-[#9F6C52]/20 p-3 outline-none focus:border-[#9F6C52] transition-colors text-base" placeholder="John Doe">
						</div>
						<div class="space-y-2">
							<label for="email" class="block text-sm font-bold uppercase tracking-wider text-[#9F6C52]">Email</label>
							<input type="email" id="email" name="email" required class="w-full bg-white/50 border border-[#9F6C52]/20 p-3 outline-none focus:border-[#9F6C52] transition-colors text-base" placeholder="john@example.com">
						</div>
					</div>

					<div class="space-y-2">
						<label for="phone" class="block text-sm font-bold uppercase tracking-wider text-[#9F6C52]">Phone Number</label>
						<input type="tel" id="phone" name="phone" required class="w-full bg-white/50 border border-[#9F6C52]/20 p-3 outline-none focus:border-[#9F6C52] transition-colors text-base" placeholder="(555) 000-0000">
					</div>

					<div class="grid grid-cols-2 gap-3 md:gap-6">
						<div class="space-y-2">
							<label for="start_date" class="block text-sm font-bold uppercase tracking-wider text-[#9F6C52]">Start Date</label>
							<input type="date" id="start_date" name="start_date" required class="w-full bg-white/50 border border-[#9F6C52]/20 p-3 outline-none focus:border-[#9F6C52] transition-colors text-base min-w-0 appearance-none min-h-[50px]">
						</div>
						<div class="space-y-2">
							<label for="end_date" class="block text-sm font-bold uppercase tracking-wider text-[#9F6C52]">End Date</label>
							<input type="date" id="end_date" name="end_date" required class="w-full bg-white/50 border border-[#9F6C52]/20 p-3 outline-none focus:border-[#9F6C52] transition-colors text-base min-w-0 appearance-none min-h-[50px]">
						</div>
					</div>

					<div class="space-y-2">
						<label for="note" class="block text-sm font-bold uppercase tracking-wider text-[#9F6C52]">Note</label>
						<textarea id="note" name="note" rows="4" class="w-full bg-white/50 border border-[#9F6C52]/20 p-3 outline-none focus:border-[#9F6C52] transition-colors text-base" placeholder="Any special requests or questions?"></textarea>
					</div>

					<!-- Calculated Price Hidden Field (for email) -->
					<input type="hidden" id="calculated_price_input" name="total_price" value="">

					<div class="pt-4">
						<button type="submit" class="w-full bg-[#92ABBB] text-white py-4 font-subheader text-lg tracking-widest hover:bg-[#9F6C52] transition-all uppercase">
							Request to Book
						</button>
						
						<!-- Price Display -->
						<div id="price-display" class="mt-6 text-center hidden">
							<p class="text-sm uppercase tracking-widest text-[#9F6C52]/60 mb-1">Estimated Total</p>
							<p id="total-amount" class="text-4xl font-header text-[#9F6C52]">$0</p>
							<p id="stay-details" class="text-xs opacity-60 mt-2 italic"></p>
						</div>

						<div id="date-error" class="mt-4 text-center hidden">
							<p class="text-sm text-red-500 font-medium">Please select a valid date range (Check-out must be after check-in).</p>
						</div>
					</div>
				</form>
			</section>
		</div>

		<footer class="mt-24 pt-8 border-t border-[#9F6C52]/10 text-center">
			<a href="/Sherri-Beach-Home/" class="text-[#92ABBB] hover:opacity-80 font-subheader text-sm tracking-widest transition-all uppercase">← Back to Home</a>
		</footer>
	</main>
</Layout>

<script is:inline define:vars={{ API_URL }}>
	const startDateInput = document.getElementById('start_date');
	const endDateInput = document.getElementById('end_date');
	const priceDisplay = document.getElementById('price-display');
	const totalAmount = document.getElementById('total-amount');
	const stayDetails = document.getElementById('stay-details');
	const dateError = document.getElementById('date-error');
	const priceHiddenInput = document.getElementById('calculated_price_input');

	let pricingData = [];
	let defaultPriceValue = 210;

	// Fetch pricing data to match calendar
	async function initPricing() {
		try {
			const response = await fetch(API_URL);
			const data = await response.json();
			pricingData = data.pricing || [];
			defaultPriceValue = parseInt((data.defaultPrice || "$210").replace('$', ''));
		} catch (e) {
			console.error("Pricing sync failed", e);
		}
	}

	function getPriceForDate(date) {
		const dateStr = date.toISOString().split('T')[0];
		const match = pricingData.find(p => {
			const start = new Date(p.startDate);
			const end = new Date(p.endDate);
			return date >= start && date <= end;
		});
		if (match) {
			return parseInt(match.price.replace('$', ''));
		}
		return defaultPriceValue;
	}

	function calculateTotal() {
		const start = new Date(startDateInput.value);
		const end = new Date(endDateInput.value);

		// Reset visibility
		priceDisplay.classList.add('hidden');
		dateError.classList.add('hidden');

		if (startDateInput.value && endDateInput.value) {
			if (end <= start) {
				dateError.classList.remove('hidden');
				return;
			}

			let total = 0;
			let nights = 0;
			let current = new Date(start);

			while (current < end) {
				total += getPriceForDate(current);
				nights++;
				current.setDate(current.getDate() + 1);
			}

			totalAmount.textContent = `$${total}`;
			stayDetails.textContent = `${nights} night${nights > 1 ? 's' : ''} at variable seasonal rates`;
			priceHiddenInput.value = `$${total} (${nights} nights)`;
			priceDisplay.classList.remove('hidden');
		}
	}

	startDateInput.addEventListener('change', calculateTotal);
	endDateInput.addEventListener('change', calculateTotal);

	initPricing();
</script>

<style>
	input[type="date"]::-webkit-calendar-picker-indicator {
		filter: sepia(50%) saturate(500%) hue-rotate(340deg) opacity(0.6);
		cursor: pointer;
	}
</style>
