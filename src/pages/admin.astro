---
import Layout from '../layouts/Layout.astro';
import AdminCalendar from '../components/AdminCalendar.astro';

const API_URL = "https://api.npoint.io/9bf5ddca826de74d7320";
---

<Layout title="Admin - Sherri's Beach Condo">
	<main class="max-w-6xl mx-auto px-4 md:px-6 py-8 md:py-12">
		<header class="mb-8 md:mb-12 text-center">
			<h1 class="text-2xl md:text-4xl font-header text-[#92ABBB] mb-2 md:mb-4">Admin Dashboard</h1>
			<p class="text-sm md:text-lg opacity-80">Manage bookings and pricing</p>
		</header>

		<!-- Forms Section - Side by Side on Desktop, Stacked on Mobile -->
		<section class="mb-10 md:mb-16 grid lg:grid-cols-2 gap-6 md:gap-8">
			<!-- Booking Form (Left) -->
			<div>
				<h2 class="text-lg md:text-xl font-subheader text-[#92ABBB] mb-4 md:mb-6 text-center">Bookings</h2>
				
				<form id="booking-form" class="bg-white/50 rounded-2xl p-4 md:p-6 shadow-sm">
					<div class="space-y-3 md:space-y-4">
						<!-- Name -->
						<div>
							<label for="name" class="block font-subheader text-xs text-[#9F6C52] mb-1.5 md:mb-2 tracking-wider">Guest Name</label>
							<input 
								type="text" 
								id="name" 
								name="name"
								placeholder="e.g., Smith Family"
								class="w-full px-3 md:px-4 py-3 bg-white/70 border border-[#A7B9C6]/30 rounded-lg font-body text-base text-[#9F6C52] focus:outline-none focus:border-[#92ABBB] transition-colors"
							/>
						</div>

						<!-- Dates Row -->
						<div class="space-y-3 md:space-y-0 md:grid md:grid-cols-2 md:gap-4">
							<div>
								<label for="startDate" class="block font-subheader text-xs text-[#9F6C52] mb-1.5 md:mb-2 tracking-wider">Start *</label>
								<input 
									type="date" 
									id="startDate" 
									name="startDate"
									required
									class="w-full h-[50px] px-3 bg-white/70 border border-[#A7B9C6]/30 rounded-lg font-body text-base text-[#9F6C52] focus:outline-none focus:border-[#92ABBB] transition-colors"
								/>
							</div>
							<div>
								<label for="endDate" class="block font-subheader text-xs text-[#9F6C52] mb-1.5 md:mb-2 tracking-wider">End *</label>
								<input 
									type="date" 
									id="endDate" 
									name="endDate"
									required
									class="w-full h-[50px] px-3 bg-white/70 border border-[#A7B9C6]/30 rounded-lg font-body text-base text-[#9F6C52] focus:outline-none focus:border-[#92ABBB] transition-colors"
								/>
							</div>
						</div>

						<!-- Availability -->
						<div>
							<label for="availability" class="block font-subheader text-xs text-[#9F6C52] mb-1.5 md:mb-2 tracking-wider">Status *</label>
							<select 
								id="availability" 
								name="availability"
								required
								class="w-full h-[50px] px-3 md:px-4 bg-white/70 border border-[#A7B9C6]/30 rounded-lg font-body text-base text-[#9F6C52] focus:outline-none focus:border-[#92ABBB] transition-colors"
							>
								<option value="booked">Booked</option>
								<option value="available">Available</option>
							</select>
						</div>

						<!-- Note -->
						<div>
							<label for="note" class="block font-subheader text-xs text-[#9F6C52] mb-1.5 md:mb-2 tracking-wider">Note (Private)</label>
							<textarea 
								id="note" 
								name="note"
								rows="2"
								placeholder="e.g., Returning guest"
								class="w-full px-3 md:px-4 py-3 bg-white/70 border border-[#A7B9C6]/30 rounded-lg font-body text-base text-[#9F6C52] focus:outline-none focus:border-[#92ABBB] transition-colors resize-none"
							></textarea>
						</div>
					</div>

					<!-- Buttons -->
					<div class="mt-5 md:mt-6 flex gap-2 md:gap-3">
						<button 
							type="submit"
							class="flex-1 bg-[#92ABBB] text-[#EEE7DD] py-3.5 md:py-3 rounded-xl font-subheader text-sm tracking-widest hover:bg-[#A7B9C6] active:bg-[#8199a8] shadow-lg hover:shadow-xl transition-all"
						>
							Save Booking
						</button>
						<button 
							type="button"
							id="clear-booking"
							class="px-4 py-3.5 md:py-3 border border-[#A7B9C6]/50 text-[#9F6C52] rounded-xl font-subheader text-xs tracking-widest hover:bg-white/50 active:bg-white/70 transition-all"
						>
							Clear
						</button>
					</div>

					<div id="booking-status" class="mt-3 text-center text-sm font-body hidden"></div>
				</form>
			</div>

			<!-- Pricing Form (Right) -->
			<div>
				<h2 class="text-lg md:text-xl font-subheader text-[#92ABBB] mb-4 md:mb-6 text-center">Pricing</h2>
				
				<form id="pricing-form" class="bg-white/50 rounded-2xl p-4 md:p-6 shadow-sm">
					<div class="space-y-3 md:space-y-4">
						<!-- Dates Row -->
						<div class="space-y-3 md:space-y-0 md:grid md:grid-cols-2 md:gap-4">
							<div>
								<label for="priceStartDate" class="block font-subheader text-xs text-[#9F6C52] mb-1.5 md:mb-2 tracking-wider">Start *</label>
								<input 
									type="date" 
									id="priceStartDate" 
									name="startDate"
									required
									class="w-full h-[50px] px-3 bg-white/70 border border-[#A7B9C6]/30 rounded-lg font-body text-base text-[#9F6C52] focus:outline-none focus:border-[#92ABBB] transition-colors"
								/>
							</div>
							<div>
								<label for="priceEndDate" class="block font-subheader text-xs text-[#9F6C52] mb-1.5 md:mb-2 tracking-wider">End *</label>
								<input 
									type="date" 
									id="priceEndDate" 
									name="endDate"
									required
									class="w-full h-[50px] px-3 bg-white/70 border border-[#A7B9C6]/30 rounded-lg font-body text-base text-[#9F6C52] focus:outline-none focus:border-[#92ABBB] transition-colors"
								/>
							</div>
						</div>

						<!-- Price -->
						<div>
							<label for="price" class="block font-subheader text-xs text-[#9F6C52] mb-1.5 md:mb-2 tracking-wider">Price per Night *</label>
							<input 
								type="text" 
								id="price" 
								name="price"
								inputmode="decimal"
								required
								placeholder="$210"
								class="w-full px-3 md:px-4 py-3 bg-white/70 border border-[#A7B9C6]/30 rounded-lg font-body text-base text-[#9F6C52] focus:outline-none focus:border-[#92ABBB] transition-colors"
							/>
						</div>

						<p class="text-xs text-[#9F6C52]/60 font-body">
							Set custom pricing for date ranges (holidays, peak season, etc.)
						</p>
					</div>

					<!-- Buttons -->
					<div class="mt-5 md:mt-6 flex gap-2 md:gap-3">
						<button 
							type="submit"
							class="flex-1 bg-[#9F6C52] text-[#EEE7DD] py-3.5 md:py-3 rounded-xl font-subheader text-sm tracking-widest hover:bg-[#8a5d46] active:bg-[#7a5240] shadow-lg hover:shadow-xl transition-all"
						>
							Set Price
						</button>
						<button 
							type="button"
							id="clear-pricing"
							class="px-4 py-3.5 md:py-3 border border-[#A7B9C6]/50 text-[#9F6C52] rounded-xl font-subheader text-xs tracking-widest hover:bg-white/50 active:bg-white/70 transition-all"
						>
							Clear
						</button>
					</div>

					<div id="pricing-status" class="mt-3 text-center text-sm font-body hidden"></div>
				</form>

				<!-- Pricing List -->
				<div id="pricing-list" class="mt-4 md:mt-6 bg-white/30 rounded-xl p-3 md:p-4">
					<h4 class="font-subheader text-xs text-[#9F6C52] mb-2 md:mb-3 tracking-wider">Custom Prices</h4>
					<div id="pricing-list-content" class="space-y-2 text-sm">
						<!-- Populated by JS -->
					</div>
				</div>
			</div>
		</section>

		<!-- Admin Calendar -->
		<section>
			<h2 class="text-xl md:text-2xl font-subheader text-[#92ABBB] mb-6 md:mb-8 text-center">Calendar Overview</h2>
			<AdminCalendar />
		</section>

		<footer class="mt-10 md:mt-16 pt-6 md:pt-8 border-t border-[#9F6C52]/10 text-center">
			<a href="/Sherri-Beach-Home/book" class="text-[#92ABBB] hover:opacity-80 font-subheader text-xs md:text-sm tracking-widest transition-all">← Back to Public Calendar</a>
		</footer>
	</main>
</Layout>

<script define:vars={{ API_URL }}>
	// === BOOKING FORM ===
	const bookingForm = document.getElementById('booking-form');
	const bookingStatus = document.getElementById('booking-status');
	const clearBookingBtn = document.getElementById('clear-booking');
	const bookingSubmitBtn = bookingForm?.querySelector('button[type="submit"]');
	
	let editingBookingId = null;

	function showBookingStatus(message, isError = false) {
		bookingStatus.textContent = message;
		bookingStatus.classList.remove('hidden', 'text-green-600', 'text-red-500');
		bookingStatus.classList.add(isError ? 'text-red-500' : 'text-green-600');
		setTimeout(() => bookingStatus.classList.add('hidden'), 3000);
	}

	function generateId() {
		return Date.now().toString(36) + Math.random().toString(36).substr(2);
	}

	function setBookingEditMode(booking) {
		editingBookingId = booking.id;
		document.getElementById('name').value = booking.name || '';
		document.getElementById('startDate').value = booking.startDate || '';
		document.getElementById('endDate').value = booking.endDate || '';
		document.getElementById('availability').value = booking.availability || 'booked';
		document.getElementById('note').value = booking.note || '';
		if (bookingSubmitBtn) bookingSubmitBtn.textContent = 'Update Booking';
		bookingForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
	}

	function clearBookingForm() {
		editingBookingId = null;
		bookingForm?.reset();
		if (bookingSubmitBtn) bookingSubmitBtn.textContent = 'Save Booking';
	}

	window.addEventListener('editBooking', (e) => setBookingEditMode(e.detail));
	clearBookingBtn?.addEventListener('click', clearBookingForm);

	bookingForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData(bookingForm);
		const startDate = formData.get('startDate');
		const endDate = formData.get('endDate');
		
		if (new Date(endDate) < new Date(startDate)) {
			showBookingStatus('End date must be after start date', true);
			return;
		}

		const bookingData = {
			id: editingBookingId || generateId(),
			name: formData.get('name') || '',
			startDate,
			endDate,
			availability: formData.get('availability'),
			note: formData.get('note') || ''
		};

		try {
			const currentData = await fetch(API_URL).then(r => r.json());
			let bookings = currentData.bookings || [];
			const pricing = currentData.pricing || [];
			const defaultPrice = currentData.defaultPrice || '$210';

			if (editingBookingId) {
				bookings = bookings.map(b => b.id === editingBookingId ? bookingData : b);
			} else {
				bookings.push(bookingData);
			}

			const response = await fetch(API_URL, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ bookings, pricing, defaultPrice })
			});

			if (response.ok) {
				showBookingStatus(editingBookingId ? 'Booking updated!' : 'Booking saved!');
				clearBookingForm();
				if (window.adminCalendarRefresh) window.adminCalendarRefresh();
			} else throw new Error('Failed');
		} catch (error) {
			showBookingStatus('Failed to save. Please try again.', true);
		}
	});

	// === PRICING FORM ===
	const pricingForm = document.getElementById('pricing-form');
	const pricingStatus = document.getElementById('pricing-status');
	const clearPricingBtn = document.getElementById('clear-pricing');
	const pricingListContent = document.getElementById('pricing-list-content');

	function showPricingStatus(message, isError = false) {
		pricingStatus.textContent = message;
		pricingStatus.classList.remove('hidden', 'text-green-600', 'text-red-500');
		pricingStatus.classList.add(isError ? 'text-red-500' : 'text-green-600');
		setTimeout(() => pricingStatus.classList.add('hidden'), 3000);
	}

	clearPricingBtn?.addEventListener('click', () => pricingForm?.reset());

	pricingForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData(pricingForm);
		const startDate = formData.get('startDate');
		const endDate = formData.get('endDate');
		let price = formData.get('price').trim();
		
		// Auto-add $ if missing
		if (price && !price.startsWith('$')) {
			price = '$' + price;
		}
		
		if (new Date(endDate) < new Date(startDate)) {
			showPricingStatus('End date must be after start date', true);
			return;
		}

		const pricingEntry = {
			id: generateId(),
			startDate,
			endDate,
			price
		};

		try {
			const currentData = await fetch(API_URL).then(r => r.json());
			const bookings = currentData.bookings || [];
			let pricing = currentData.pricing || [];
			const defaultPrice = currentData.defaultPrice || '$210';

			// Surgical split: preserve non-overlapping portions of existing ranges
			const newStart = new Date(startDate);
			const newEnd = new Date(endDate);
			const updatedPricing = [];

			for (const p of pricing) {
				const existingStart = new Date(p.startDate);
				const existingEnd = new Date(p.endDate);

				// No overlap — keep as-is
				if (existingEnd < newStart || existingStart > newEnd) {
					updatedPricing.push(p);
					continue;
				}

				// Overlap exists — split the existing range

				// Part before the new range
				if (existingStart < newStart) {
					const dayBefore = new Date(newStart);
					dayBefore.setDate(dayBefore.getDate() - 1);
					updatedPricing.push({
						id: generateId(),
						startDate: p.startDate,
						endDate: dayBefore.toISOString().split('T')[0],
						price: p.price
					});
				}

				// Part after the new range
				if (existingEnd > newEnd) {
					const dayAfter = new Date(newEnd);
					dayAfter.setDate(dayAfter.getDate() + 1);
					updatedPricing.push({
						id: generateId(),
						startDate: dayAfter.toISOString().split('T')[0],
						endDate: p.endDate,
						price: p.price
					});
				}
			}

			// Add the new pricing entry
			updatedPricing.push(pricingEntry);
			pricing = updatedPricing;

			const response = await fetch(API_URL, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ bookings, pricing, defaultPrice })
			});

			if (response.ok) {
				showPricingStatus('Price set!');
				pricingForm.reset();
				if (window.adminCalendarRefresh) window.adminCalendarRefresh();
				renderPricingList(pricing);
			} else throw new Error('Failed');
		} catch (error) {
			showPricingStatus('Failed to save. Please try again.', true);
		}
	});

	async function deletePricing(id) {
		try {
			const currentData = await fetch(API_URL).then(r => r.json());
			const bookings = currentData.bookings || [];
			const pricing = (currentData.pricing || []).filter(p => p.id !== id);
			const defaultPrice = currentData.defaultPrice || '$210';

			const response = await fetch(API_URL, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ bookings, pricing, defaultPrice })
			});

			if (response.ok) {
				if (window.adminCalendarRefresh) window.adminCalendarRefresh();
				renderPricingList(pricing);
			}
		} catch (error) {
			console.error('Delete pricing error:', error);
		}
	}

	function renderPricingList(pricing) {
		if (!pricingListContent) return;
		
		if (!pricing || pricing.length === 0) {
			pricingListContent.innerHTML = '<p class="text-xs opacity-60">No custom prices set. Default: $210/night</p>';
			return;
		}

		const sorted = [...pricing].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
		pricingListContent.innerHTML = sorted.map(p => `
			<div class="flex items-center justify-between py-2 border-b border-[#9F6C52]/10 last:border-0">
				<div>
					<span class="font-semibold text-[#9F6C52]">${p.price}</span>
					<span class="text-[#9F6C52]/60 text-xs ml-2">${p.startDate} → ${p.endDate}</span>
				</div>
				<button class="delete-pricing text-xs text-red-400 hover:text-red-600" data-id="${p.id}">×</button>
			</div>
		`).join('');

		pricingListContent.querySelectorAll('.delete-pricing').forEach(btn => {
			btn.addEventListener('click', () => deletePricing(btn.dataset.id));
		});
	}

	// Load initial pricing list
	fetch(API_URL).then(r => r.json()).then(data => renderPricingList(data.pricing));
</script>
