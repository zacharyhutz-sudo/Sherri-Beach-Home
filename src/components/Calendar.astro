---
// Calendar component for Sherri's Beach Home
// Data fetched from npoint.io API
const API_URL = "https://api.npoint.io/9bf5ddca826de74d7320";
---

<div class="calendar-container">
  <!-- Loading State -->
  <div id="calendar-loading" class="text-center py-12">
    <div class="inline-block w-8 h-8 border-2 border-[#A7B9C6] border-t-transparent rounded-full animate-spin"></div>
    <p class="mt-4 text-sm opacity-60">Loading calendar...</p>
  </div>

  <div id="calendar-content" class="hidden">
    <!-- Month Navigation -->
    <div class="flex items-center justify-center gap-4 md:gap-6 mb-6 md:mb-8">
      <button id="prev-month" class="p-2 md:p-3 rounded-full hover:bg-[#A7B9C6]/20 transition-colors" aria-label="Previous month">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 md:w-6 md:h-6 text-[#9F6C52]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <h3 id="month-year" class="text-xl md:text-2xl font-header text-[#9F6C52] min-w-[180px] md:min-w-[240px] text-center"></h3>
      <button id="next-month" class="p-2 md:p-3 rounded-full hover:bg-[#A7B9C6]/20 transition-colors" aria-label="Next month">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 md:w-6 md:h-6 text-[#9F6C52]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>

    <!-- Desktop Calendar Grid -->
    <div class="hidden md:block bg-white/50 rounded-2xl p-4 md:p-6 shadow-sm">
      <!-- Day Headers -->
      <div class="grid grid-cols-7 gap-2 mb-2">
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Sun</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Mon</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Tue</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Wed</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Thu</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Fri</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Sat</div>
      </div>
      
      <!-- Date Grid -->
      <div id="calendar-grid" class="grid grid-cols-7 gap-2">
        <!-- Populated by JavaScript -->
      </div>
    </div>

    <!-- Mobile Calendar List -->
    <div class="md:hidden bg-white/50 rounded-2xl p-4 shadow-sm">
      <div id="calendar-mobile" class="space-y-2">
        <!-- Populated by JavaScript -->
      </div>
    </div>

    <!-- Legend -->
    <div class="flex justify-center gap-6 md:gap-8 mt-6">
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 md:w-4 md:h-4 rounded bg-[#d8f0d8] border border-[#b8d8b8]"></div>
        <span class="text-xs md:text-sm font-body text-[#9F6C52]/70">Available</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 md:w-4 md:h-4 rounded bg-[#f5d4cf] border border-[#e8b8b0]"></div>
        <span class="text-xs md:text-sm font-body text-[#9F6C52]/70">Booked</span>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ API_URL }}>
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const dayNamesFull = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                      'July', 'August', 'September', 'October', 'November', 'December'];
  
  let currentDate = new Date();
  let displayMonth = currentDate.getMonth();
  let displayYear = currentDate.getFullYear();
  
  // Data from API
  let bookings = [];
  let pricing = [];
  let defaultPrice = "$210";

  // Fetch data from npoint
  async function fetchBookings() {
    try {
      const response = await fetch(API_URL);
      const data = await response.json();
      bookings = data.bookings || [];
      pricing = data.pricing || [];
      defaultPrice = data.defaultPrice || "$210";
      
      document.getElementById('calendar-loading').classList.add('hidden');
      document.getElementById('calendar-content').classList.remove('hidden');
      
      renderCalendar();
    } catch (error) {
      console.error('Failed to fetch bookings:', error);
      document.getElementById('calendar-loading').innerHTML = 
        '<p class="text-sm text-red-500">Failed to load calendar. Please refresh.</p>';
    }
  }

  function getBookingForDate(year, month, day) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    return bookings.find(b => {
      const start = new Date(b.startDate);
      const end = new Date(b.endDate);
      const check = new Date(dateStr);
      return check >= start && check <= end;
    });
  }

  function getPriceForDate(year, month, day) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const priceEntry = pricing.find(p => {
      const start = new Date(p.startDate);
      const end = new Date(p.endDate);
      const check = new Date(dateStr);
      return check >= start && check <= end;
    });
    return priceEntry?.price || defaultPrice;
  }

  function isToday(year, month, day) {
    const today = new Date();
    return today.getFullYear() === year && 
           today.getMonth() === month && 
           today.getDate() === day;
  }

  function isPast(year, month, day) {
    const date = new Date(year, month, day);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return date < today;
  }

  function getDaysInMonth(year, month) {
    return new Date(year, month + 1, 0).getDate();
  }

  function getFirstDayOfMonth(year, month) {
    return new Date(year, month, 1).getDay();
  }

  function renderCalendar() {
    renderDesktopCalendar();
    renderMobileCalendar();
  }

  function renderDesktopCalendar() {
    const grid = document.getElementById('calendar-grid');
    const monthYear = document.getElementById('month-year');
    
    monthYear.textContent = `${monthNames[displayMonth]} ${displayYear}`;
    
    const daysInMonth = getDaysInMonth(displayYear, displayMonth);
    const firstDay = getFirstDayOfMonth(displayYear, displayMonth);
    
    let html = '';
    
    // Empty cells for days before the first of the month
    for (let i = 0; i < firstDay; i++) {
      html += '<div class="aspect-square"></div>';
    }
    
    // Date cells
    for (let day = 1; day <= daysInMonth; day++) {
      const today = isToday(displayYear, displayMonth, day);
      const past = isPast(displayYear, displayMonth, day);
      const dayOfWeek = (firstDay + day - 1) % 7;
      const booking = getBookingForDate(displayYear, displayMonth, day);
      const isBooked = booking && booking.availability === 'booked';
      const price = getPriceForDate(displayYear, displayMonth, day);
      
      let bgClass = isBooked ? 'bg-[#f5d4cf]' : 'bg-[#d8f0d8]';
      let borderClass = today ? 'ring-2 ring-[#9F6C52] ring-offset-2' : '';
      let opacityClass = past ? 'opacity-50' : '';
      let statusText = isBooked ? 'Booked' : 'Available';
      let statusColor = isBooked ? 'text-[#c45a4a]' : 'text-[#5a9a5a]';
      
      html += `
        <div class="aspect-square ${bgClass} ${borderClass} ${opacityClass} rounded-lg p-2 flex flex-col transition-all hover:shadow-md">
          <div class="flex justify-between items-start">
            <span class="font-subheader text-[10px] text-[#9F6C52]/60 tracking-wider">${dayNames[dayOfWeek]}</span>
            <span class="font-header text-lg text-[#9F6C52]">${day}</span>
          </div>
          <div class="flex-1 flex flex-col items-center justify-end pb-1 gap-0.5">
            <span class="font-body text-xs ${statusColor} font-medium">${statusText}</span>
            <span class="font-subheader text-sm text-[#9F6C52] font-semibold">${price}</span>
          </div>
        </div>
      `;
    }
    
    grid.innerHTML = html;
  }

  function renderMobileCalendar() {
    const mobileContainer = document.getElementById('calendar-mobile');
    if (!mobileContainer) return;
    
    const daysInMonth = getDaysInMonth(displayYear, displayMonth);
    const firstDay = getFirstDayOfMonth(displayYear, displayMonth);
    
    let html = '';
    
    // Group by weeks for mobile
    let currentWeek = [];
    
    for (let day = 1; day <= daysInMonth; day++) {
      const today = isToday(displayYear, displayMonth, day);
      const past = isPast(displayYear, displayMonth, day);
      const dayOfWeek = (firstDay + day - 1) % 7;
      const booking = getBookingForDate(displayYear, displayMonth, day);
      const isBooked = booking && booking.availability === 'booked';
      const price = getPriceForDate(displayYear, displayMonth, day);
      
      let bgClass = isBooked ? 'bg-[#f5d4cf]' : 'bg-[#d8f0d8]';
      let borderClass = today ? 'ring-2 ring-[#9F6C52]' : '';
      let opacityClass = past ? 'opacity-50' : '';
      let statusText = isBooked ? 'Booked' : 'Available';
      let statusColor = isBooked ? 'text-[#c45a4a]' : 'text-[#5a9a5a]';
      
      html += `
        <div class="flex items-center justify-between ${bgClass} ${borderClass} ${opacityClass} rounded-lg px-4 py-3">
          <div class="flex items-center gap-3">
            <div class="text-center min-w-[45px]">
              <div class="font-header text-xl text-[#9F6C52]">${day}</div>
              <div class="font-subheader text-[10px] text-[#9F6C52]/60 tracking-wider">${dayNames[dayOfWeek]}</div>
            </div>
            <span class="font-body text-sm ${statusColor} font-medium">${statusText}</span>
          </div>
          <span class="font-subheader text-lg text-[#9F6C52] font-semibold">${price}</span>
        </div>
      `;
    }
    
    mobileContainer.innerHTML = html;
  }

  // Event listeners
  document.getElementById('prev-month')?.addEventListener('click', () => {
    displayMonth--;
    if (displayMonth < 0) {
      displayMonth = 11;
      displayYear--;
    }
    renderCalendar();
  });

  document.getElementById('next-month')?.addEventListener('click', () => {
    displayMonth++;
    if (displayMonth > 11) {
      displayMonth = 0;
      displayYear++;
    }
    renderCalendar();
  });

  // Initial fetch
  fetchBookings();

  // Update at midnight to refresh "today" highlight
  function scheduleNextDayUpdate() {
    const now = new Date();
    const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
    const msUntilMidnight = tomorrow - now;
    
    setTimeout(() => {
      currentDate = new Date();
      fetchBookings(); // Re-fetch data at midnight
      scheduleNextDayUpdate();
    }, msUntilMidnight);
  }
  
  scheduleNextDayUpdate();
</script>

<style>
  .calendar-container {
    max-width: 700px;
    margin: 0 auto;
  }
</style>
