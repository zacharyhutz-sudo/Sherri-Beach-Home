---
// Admin Calendar component - shows extended booking info (Name, Note)
const API_URL = "https://api.npoint.io/9bf5ddca826de74d7320";
---

<div class="admin-calendar-container">
  <!-- Loading State -->
  <div id="admin-calendar-loading" class="text-center py-12">
    <div class="inline-block w-8 h-8 border-2 border-[#A7B9C6] border-t-transparent rounded-full animate-spin"></div>
    <p class="mt-4 text-sm opacity-60">Loading calendar...</p>
  </div>

  <div id="admin-calendar-content" class="hidden">
    <!-- Month Navigation -->
    <div class="flex items-center justify-center gap-6 mb-8">
      <button id="admin-prev-month" class="p-3 rounded-full hover:bg-[#A7B9C6]/20 transition-colors" aria-label="Previous month">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-[#9F6C52]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <h3 id="admin-month-year" class="text-2xl font-header text-[#9F6C52] min-w-[240px] text-center"></h3>
      <button id="admin-next-month" class="p-3 rounded-full hover:bg-[#A7B9C6]/20 transition-colors" aria-label="Next month">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-[#9F6C52]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>

    <!-- Calendar Grid -->
    <div class="bg-white/50 rounded-2xl p-4 md:p-6 shadow-sm">
      <!-- Day Headers -->
      <div class="grid grid-cols-7 gap-2 mb-2">
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Sun</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Mon</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Tue</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Wed</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Thu</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Fri</div>
        <div class="text-center font-subheader text-xs text-[#A7B9C6] py-2">Sat</div>
      </div>
      
      <!-- Date Grid -->
      <div id="admin-calendar-grid" class="grid grid-cols-7 gap-2">
        <!-- Populated by JavaScript -->
      </div>
    </div>

    <!-- Legend -->
    <div class="flex justify-center gap-8 mt-6">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded bg-[#d8f0d8] border border-[#b8d8b8]"></div>
        <span class="text-sm font-body text-[#9F6C52]/70">Available</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded bg-[#f5d4cf] border border-[#e8b8b0]"></div>
        <span class="text-sm font-body text-[#9F6C52]/70">Booked</span>
      </div>
    </div>

    <!-- Bookings List -->
    <div id="bookings-list" class="mt-8 bg-white/50 rounded-2xl p-6">
      <h4 class="font-subheader text-lg text-[#9F6C52] mb-4">All Bookings</h4>
      <div id="bookings-list-content" class="space-y-3">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<script define:vars={{ API_URL }}>
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                      'July', 'August', 'September', 'October', 'November', 'December'];
  
  let currentDate = new Date();
  let displayMonth = currentDate.getMonth();
  let displayYear = currentDate.getFullYear();
  
  // Data from API
  let bookings = [];
  let defaultPrice = "$210";

  // Expose for external refresh
  window.adminCalendarRefresh = fetchBookings;

  // Fetch data from npoint
  async function fetchBookings() {
    try {
      const response = await fetch(API_URL);
      const data = await response.json();
      bookings = data.bookings || [];
      defaultPrice = data.defaultPrice || "$210";
      
      document.getElementById('admin-calendar-loading')?.classList.add('hidden');
      document.getElementById('admin-calendar-content')?.classList.remove('hidden');
      
      renderCalendar();
      renderBookingsList();
    } catch (error) {
      console.error('Failed to fetch bookings:', error);
      const loading = document.getElementById('admin-calendar-loading');
      if (loading) {
        loading.innerHTML = '<p class="text-sm text-red-500">Failed to load calendar. Please refresh.</p>';
      }
    }
  }

  function getBookingForDate(year, month, day) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    return bookings.find(b => {
      const start = new Date(b.startDate);
      const end = new Date(b.endDate);
      const check = new Date(dateStr);
      return check >= start && check <= end;
    });
  }

  function isToday(year, month, day) {
    const today = new Date();
    return today.getFullYear() === year && 
           today.getMonth() === month && 
           today.getDate() === day;
  }

  function isPast(year, month, day) {
    const date = new Date(year, month, day);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return date < today;
  }

  function getDaysInMonth(year, month) {
    return new Date(year, month + 1, 0).getDate();
  }

  function getFirstDayOfMonth(year, month) {
    return new Date(year, month, 1).getDay();
  }

  function renderCalendar() {
    const grid = document.getElementById('admin-calendar-grid');
    const monthYear = document.getElementById('admin-month-year');
    
    if (!grid || !monthYear) return;
    
    monthYear.textContent = `${monthNames[displayMonth]} ${displayYear}`;
    
    const daysInMonth = getDaysInMonth(displayYear, displayMonth);
    const firstDay = getFirstDayOfMonth(displayYear, displayMonth);
    
    let html = '';
    
    // Empty cells for days before the first of the month
    for (let i = 0; i < firstDay; i++) {
      html += '<div class="min-h-[120px]"></div>';
    }
    
    // Date cells
    for (let day = 1; day <= daysInMonth; day++) {
      const today = isToday(displayYear, displayMonth, day);
      const past = isPast(displayYear, displayMonth, day);
      const dayOfWeek = (firstDay + day - 1) % 7;
      const booking = getBookingForDate(displayYear, displayMonth, day);
      const isBooked = booking && booking.availability === 'booked';
      const price = booking?.price || defaultPrice;
      const name = booking?.name || '';
      const note = booking?.note || '';
      
      let bgClass = isBooked ? 'bg-[#f5d4cf]' : 'bg-[#d8f0d8]';
      let borderClass = today ? 'ring-2 ring-[#9F6C52] ring-offset-2' : '';
      let opacityClass = past ? 'opacity-50' : '';
      let statusText = isBooked ? 'Booked' : 'Available';
      let statusColor = isBooked ? 'text-[#c45a4a]' : 'text-[#5a9a5a]';
      
      html += `
        <div class="min-h-[120px] ${bgClass} ${borderClass} ${opacityClass} rounded-lg p-2 flex flex-col transition-all hover:shadow-md">
          <div class="flex justify-between items-start mb-1">
            <span class="font-subheader text-[9px] text-[#9F6C52]/60 tracking-wider">${dayNames[dayOfWeek]}</span>
            <span class="font-header text-lg text-[#9F6C52]">${day}</span>
          </div>
          <div class="flex-1 flex flex-col gap-1">
            <span class="font-body text-[10px] ${statusColor} font-medium">${statusText}</span>
            <span class="font-subheader text-sm text-[#9F6C52] font-semibold">${price}</span>
            ${name ? `<span class="font-body text-[10px] text-[#9F6C52]/80 truncate" title="${name}">${name}</span>` : ''}
            ${note ? `<span class="font-body text-[9px] text-[#9F6C52]/60 truncate italic" title="${note}">${note}</span>` : ''}
          </div>
        </div>
      `;
    }
    
    grid.innerHTML = html;
  }

  function renderBookingsList() {
    const listContent = document.getElementById('bookings-list-content');
    if (!listContent) return;
    
    if (bookings.length === 0) {
      listContent.innerHTML = '<p class="text-sm opacity-60">No bookings yet.</p>';
      return;
    }
    
    // Sort by start date
    const sorted = [...bookings].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
    
    let html = '';
    for (const booking of sorted) {
      const isBooked = booking.availability === 'booked';
      const bgClass = isBooked ? 'bg-[#f5d4cf]/50' : 'bg-[#d8f0d8]/50';
      const statusText = isBooked ? 'Booked' : 'Available';
      const statusColor = isBooked ? 'text-[#c45a4a]' : 'text-[#5a9a5a]';
      
      html += `
        <div class="p-4 ${bgClass} rounded-lg flex flex-col md:flex-row md:items-center justify-between gap-2">
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-1">
              <span class="font-subheader text-sm text-[#9F6C52]">${booking.name || 'Unnamed'}</span>
              <span class="font-body text-xs ${statusColor} font-medium">${statusText}</span>
              <span class="font-subheader text-sm text-[#9F6C52] font-semibold">${booking.price || defaultPrice}</span>
            </div>
            <div class="font-body text-xs text-[#9F6C52]/70">
              ${booking.startDate} â†’ ${booking.endDate}
            </div>
            ${booking.note ? `<div class="font-body text-xs text-[#9F6C52]/60 italic mt-1">${booking.note}</div>` : ''}
          </div>
          <button 
            class="delete-booking text-xs text-red-400 hover:text-red-600 font-subheader transition-colors"
            data-id="${booking.id}"
          >
            Delete
          </button>
        </div>
      `;
    }
    
    listContent.innerHTML = html;
    
    // Add delete handlers
    listContent.querySelectorAll('.delete-booking').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if (confirm('Delete this booking?')) {
          await deleteBooking(id);
        }
      });
    });
  }

  async function deleteBooking(id) {
    const newBookings = bookings.filter(b => b.id !== id);
    
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bookings: newBookings, defaultPrice })
      });
      
      if (response.ok) {
        bookings = newBookings;
        renderCalendar();
        renderBookingsList();
      } else {
        alert('Failed to delete booking. Please try again.');
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('Failed to delete booking. Please try again.');
    }
  }

  // Event listeners
  document.getElementById('admin-prev-month')?.addEventListener('click', () => {
    displayMonth--;
    if (displayMonth < 0) {
      displayMonth = 11;
      displayYear--;
    }
    renderCalendar();
  });

  document.getElementById('admin-next-month')?.addEventListener('click', () => {
    displayMonth++;
    if (displayMonth > 11) {
      displayMonth = 0;
      displayYear++;
    }
    renderCalendar();
  });

  // Initial fetch
  fetchBookings();
</script>

<style>
  .admin-calendar-container {
    max-width: 900px;
    margin: 0 auto;
  }
</style>
